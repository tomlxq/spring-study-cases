# 分布式事务管理

## 分布式事务产生背景

[database transaction]

数据库事务要满足几个要求：ACID

Atomic(原子性)   事务必须是原子的工作单元

Consistent(一致性)  事务完成时，必须使所有数据都保持一致状态

Isolation(隔离性)   并发事务所做的修改必须和其他事务所做的修改是隔离的

Duration（持久性） 事务完成之后，对系统的影响是永久性的

Mysql里的事务处理过程

1. 记录redo和undo log文件，确保日志在磁盘上的持久化

2. 更新数据记录

3. 提交事务 ，redo 写入commit记录

## 分布式事务

### 数据库分库分表

<img src="img/clip_image002.jpg" alt="img" style="zoom:50%;" />

 

### SOA化

<img src="img/clip_image004.jpg" alt="img" style="zoom:50%;" />

 

## X/OpenDTP事务模型

X/Open Distributed Transaction Processing Reference Model 

X/Open是一个组织机构，定义出的一套分布式事务标准， 定义了规范的API接口

2PC（two -phase-commit）, 用来保证分布式事务的完整性

J2EE 遵循了X/open DTP规范，设计并实现了java里面的分布式事务编程接口规范-JTA

XA是X/Open DTP定义的中间件与数据库之间的接口规范。 XA接口函数由数据库厂商提供

### X/OpenDTP 角色

* AP application      

* RM resources manager  资源管理器。一般指数据库或文件系统

* TM transaction manager 事务管理器，事务协调者。

![image-20200101164304650](img/image-20200101164304650.png)

### 2PC（two -phase-commit）

(CAP)

#### 阶段一：提交事务请求（投票）

1. TM向所有的AP发送事务内容，询问是否可以执行事务的提交操作，并等待各个AP的响应

2. 执行事务

   各个AP节点执行事务操作，将undo和redo信息记录到事务日志中，尽量把提交过程中所消耗时间的操作和准备都提前完成后确保后续

   事务提交的成功率

3. 各个AP向TM反馈事务询问的响应

   各个AP成功执行了事务操作，那么反馈给TM yes的response；如果AP没有成功执行事务，就反馈TM no的response

#### 阶段二：执行事务提交

##### 执行提交事务

![img](img/clip_image0021.jpg)

假设一个事务的提交过程总共需要30s， 其中prepare操作需要28（事务日志落地磁盘及各种io操作），而真正commit只需要2s

那么，commit阶段发生错误的概率和prepare相比， 2/28 (<10%) .只要第一个阶段成功，那么commit阶段出现失败的概率就非常小

大大增加了分布式事务的成功概率

##### 中断事务提交

![img](img/clip_image0041.jpg)

 

2pc存在的问题

1. 数据一致性问题

2. 同步阻塞

### 3PC(three phase commit)

阶段一：canCommit

阶段二：preCommit

阶段三：doCommit

 

## 分布式事务的实现

JOTM(java open transaction manager)

Atomikos

![image-20200104182304204](img\image-20200104182304204.png)

### 用户中心
#### 父`pom.xml`

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <artifactId>gs-xtransaction-demo</artifactId>
    <groupId>com.tom</groupId>
    <version>1.0-SNAPSHOT</version>
    <packaging>pom</packaging>
    <modules>
        <module>order-api</module>
        <module>order-provider</module>
        <module>user-api</module>
        <module>user-provider</module>
        <module>gs-site</module>
    </modules>
    <properties>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <maven.compiler.source>1.8</maven.compiler.source>
        <maven.compiler.target>1.8</maven.compiler.target>
        <spring.version>5.2.2.RELEASE</spring.version>
    </properties>
    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>junit</groupId>
                <artifactId>junit</artifactId>
                <version>4.12</version>
                <scope>test</scope>
            </dependency>
            <!-- spring-->
            <dependency>
                <groupId>org.springframework</groupId>
                <artifactId>spring-core</artifactId>
                <version>${spring.version}</version>
            </dependency>
            <dependency>
                <groupId>org.springframework</groupId>
                <artifactId>spring-beans</artifactId>
                <version>${spring.version}</version>
            </dependency>
            <dependency>
                <groupId>org.springframework</groupId>
                <artifactId>spring-context</artifactId>
                <version>${spring.version}</version>
            </dependency>
            <dependency>
                <groupId>org.springframework</groupId>
                <artifactId>spring-context-support</artifactId>
                <version>${spring.version}</version>
            </dependency>
            <dependency>
                <groupId>org.springframework</groupId>
                <artifactId>spring-tx</artifactId>
                <version>${spring.version}</version>
            </dependency>
            <dependency>
                <groupId>org.springframework</groupId>
                <artifactId>spring-jdbc</artifactId>
                <version>${spring.version}</version>
            </dependency>
            <dependency>
                <groupId>org.springframework</groupId>
                <artifactId>spring-orm</artifactId>
                <version>${spring.version}</version>
            </dependency>
            <!--dubbo-->
            <dependency>
                <groupId>com.alibaba</groupId>
                <artifactId>dubbo</artifactId>
                <version>2.5.3</version>
                <exclusions>
                    <exclusion>
                        <groupId>org.springframework</groupId>
                        <artifactId>spring</artifactId>
                    </exclusion>
                </exclusions>
            </dependency>
            <dependency>
                <groupId>com.github.sgroschupf</groupId>
                <artifactId>zkclient</artifactId>
                <version>0.1</version>
            </dependency>

            <dependency>
                <groupId>com.atomikos</groupId>
                <artifactId>transactions-jdbc</artifactId>
                <version>4.0.6</version>
            </dependency>
            <dependency>
                <groupId>javax</groupId>
                <artifactId>javaee-api</artifactId>
                <version>8.0.1</version>
            </dependency>
            <dependency>
                <groupId>javax.transaction</groupId>
                <artifactId>jta</artifactId>
                <version>1.1</version>
            </dependency>
            <dependency>
                <groupId>com.tom</groupId>
                <artifactId>order-api</artifactId>
                <version>1.0-SNAPSHOT</version>
            </dependency>
            <dependency>
                <groupId>com.tom</groupId>
                <artifactId>user-api</artifactId>
                <version>1.0-SNAPSHOT</version>
            </dependency>
            <dependency>
                <groupId>org.projectlombok</groupId>
                <artifactId>lombok</artifactId>
                <version> 1.18.10</version>
            </dependency>
            <dependency>
                <groupId>org.slf4j</groupId>
                <artifactId>slf4j-simple</artifactId>
                <version>1.7.6</version>
            </dependency>
            <dependency>
                <groupId>com.alibaba</groupId>
                <artifactId>fastjson</artifactId>
                <version>1.2.61</version>
            </dependency>
            <!--mybatis-->
            <dependency>
                <groupId>org.mybatis</groupId>
                <artifactId>mybatis</artifactId>
                <version> 3.5.3</version>
            </dependency>

            <dependency>
                <groupId>mysql</groupId>
                <artifactId>mysql-connector-java</artifactId>
                <version>8.0.18</version>
            </dependency>
            <dependency>
                <groupId>org.mybatis</groupId>
                <artifactId>mybatis-spring</artifactId>
                <version> 2.0.3</version>
            </dependency>
        </dependencies>
    </dependencyManagement>
</project>
```

#### user-api

##### `pom.xml`

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>gs-xtransaction-demo</artifactId>
        <groupId>com.tom</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>
    <artifactId>user-api</artifactId>
    <name>user-api</name>
    <dependencies>
        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
        </dependency>
        <dependency>
            <groupId>org.slf4j</groupId>
            <artifactId>slf4j-simple</artifactId>
        </dependency>
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>fastjson</artifactId>
        </dependency>
    </dependencies>
</project>
```

##### `RechargeReq.java`

```java
@Data
@NoArgsConstructor
public class RechargeReq implements Serializable {
    private static final long serialVersionUID = 6136275589530532330L;
}
```

##### `RechargeRes.java`

```java
@Data
@NoArgsConstructor
@AllArgsConstructor
public class RechargeRes implements Serializable {
    private static final long serialVersionUID = -4001523296454073592L;
    private String code;
    private String desc;
}
```

##### `UserService.java`

```java
public interface UserService {
    RechargeRes recharge(RechargeReq rechargeReq);
}
```

##### `META-INF/client/user-customer.xml`

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:dubbo="http://code.alibabatech.com/schema/dubbo"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/context
        http://www.springframework.org/schema/context/spring-context-3.0.xsd
        http://code.alibabatech.com/schema/dubbo
        http://code.alibabatech.com/schema/dubbo/dubbo.xsd" default-autowire="byName">
    <context:annotation-config/>
    <dubbo:reference id="userServices"
                     interface="com.tom.service.UserService"
                     protocol="dubbo">
    </dubbo:reference>
</beans>
```

#### user-provider

##### `pom.xml`

```java
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>gs-xtransaction-demo</artifactId>
        <groupId>com.tom</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>
    <artifactId>user-provider</artifactId>
    <dependencies>
        <dependency>
            <groupId>com.tom</groupId>
            <artifactId>order-api</artifactId>
        </dependency>
        <dependency>
            <groupId>com.tom</groupId>
            <artifactId>user-api</artifactId>
        </dependency>

        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
        </dependency>
        <!-- spring-->
        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-core</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-beans</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-context</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-context-support</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-jdbc</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-orm</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-tx</artifactId>
        </dependency>


        <!--dubbo-->
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>dubbo</artifactId>
        </dependency>
        <dependency>
            <groupId>com.github.sgroschupf</groupId>
            <artifactId>zkclient</artifactId>
        </dependency>

        <dependency>
            <groupId>com.atomikos</groupId>
            <artifactId>transactions-jdbc</artifactId>
        </dependency>

        <dependency>
            <groupId>javax.transaction</groupId>
            <artifactId>jta</artifactId>
        </dependency>
        <dependency>
            <groupId>javax</groupId>
            <artifactId>javaee-api</artifactId>
        </dependency>

        <!--mybatis-->
        <dependency>
            <groupId>org.mybatis</groupId>
            <artifactId>mybatis</artifactId>
        </dependency>
        <dependency>
            <groupId>org.mybatis</groupId>
            <artifactId>mybatis-spring</artifactId>
        </dependency>
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
        </dependency>
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>fastjson</artifactId>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
        </dependency>
        <dependency>
            <groupId>org.slf4j</groupId>
            <artifactId>slf4j-simple</artifactId>
        </dependency>
    </dependencies>
</project>
```

##### `UserDao.java`

```java
public interface UserDao {
    void updateUser();
}
```

##### `UserDaoImpl.java`

```java
@Repository
public class UserDaoImpl implements UserDao {
    @Autowired
    JdbcTemplate userJdbcTemplate;
    @Override
    public void updateUser() {
        userJdbcTemplate.execute
                ("update user set name='tom',mobile='1378088888'," +
                        "sex='male' where id=4");
    }
}
```

##### `UserServiceImpl.java`

```java
@Service("userService")
@Slf4j
public class UserServiceImpl implements UserService {
    @Autowired
    UserDao userDao;

    @Override
    public LoginResponse login(LoginRequest loginRequest) {
        log.info("登陆请求参数：" + JSON.toJSONString(loginRequest));
        LoginResponse response = new LoginResponse("0000000", "用户登陆成功");
        return response;
    }

    @Override
    public RechargeRes recharge(RechargeReq rechargeReq) {
        log.info("调到用户中心 {}",JSON.toJSONString(rechargeReq));
        RechargeRes rechargeRes = new RechargeRes("10000", "更新用户成功");
        userDao.updateUser();
        return rechargeRes;
    }
}
```

##### 应用启动类`Bootstrap.java`

```java
public class Bootstrap {
    public static void main(String[] args) {
        System.setProperty("java.net.preferIPv4Stack", "true");
        Main.main(args);
    }
}
```

##### `log4j.properties`

```properties
log4j.rootLogger=DEBUG, stdout
log4j.appender.stdout=org.apache.log4j.ConsoleAppender
log4j.appender.stdout.layout=org.apache.log4j.PatternLayout
log4j.appender.stdout.layout.ConversionPattern=%d %p [%c] - %m%n
```

##### `application.properties`

```properties
application.name=dubbo-user
dubbo.service.provider.port=20881
dubbo.service.provider.threads=200
dubbo.cache.dir=/tmp/cache
dubbo.zk.servers=192.168.238.150:2181,192.168.238.155:2181,192.168.238.160:2181,192.168.238.165:2181
dubbo.zk.group=dubbo-dev
dubbo.application.owner=tom,jack
dubbo.protocol.accesslog=/tmp/dubbo-user.log
```

##### `transactions.properties`

```properties
com.atomikos.icatch.log_base_dir=/tmp/user/
com.atomikos.icatch.output_dir=/tmp/user/
```

##### `META-INF/spring/service-user.xml`

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:dubbo="http://code.alibabatech.com/schema/dubbo"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://code.alibabatech.com/schema/dubbo
        http://code.alibabatech.com/schema/dubbo/dubbo.xsd" default-autowire="byName">
    <!--服务发布的配置，需要暴露的服务接口-->
    <dubbo:service interface="com.tom.service.UserService" ref="userService"
                   protocol="dubbo" timeout="3000"/>
</beans>
```

##### `META-INF/spring/service-provider.xml`

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:dubbo="http://code.alibabatech.com/schema/dubbo"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://code.alibabatech.com/schema/dubbo
        http://code.alibabatech.com/schema/dubbo/dubbo.xsd" default-autowire="byName">
    <!--当前项目在整个分布式架构里面的唯一名称，计算依赖关系的标签-->
    <dubbo:application name="${application.name}" owner="${dubbo.application.owner}"/>
    <!--dubbo这个服务所要暴露的服务地址所对应的注册中心-->
    <dubbo:registry protocol="zookeeper"
                    address="${dubbo.zk.servers}"
                    group="${dubbo.zk.group}"
                    file="${dubbo.cache.dir}/dubbo-order.cache"/>
    <!--当前服务发布所依赖的协议；webserovice、Thrift、Hessain、http-->
    <dubbo:protocol
            name="dubbo"
            port="${dubbo.service.provider.port}"
            threadpool="cached"
            threads="${dubbo.service.provider.threads:200}"
            accesslog="${dubbo.protocol.accesslog}"/>
    <import resource="classpath*:META-INF/client/user-customer.xml"/>
</beans>
```

##### `META-INF/spring/service-common.xml`

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:tx="http://www.springframework.org/schema/tx"
       xmlns:context="http://www.springframework.org/schema/context"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/tx
        http://www.springframework.org/schema/tx/spring-tx-4.3.xsd
        http://www.springframework.org/schema/context
        http://www.springframework.org/schema/context/spring-context-4.3.xsd" default-autowire="byName">
    <context:property-placeholder location="classpath:application.properties"/>
    <bean id="abstractXADataSource" class="com.atomikos.jdbc.AtomikosDataSourceBean" init-method="init"
          destroy-method="close" abstract="true">
        <property name="xaDataSourceClassName" value="com.mysql.cj.jdbc.MysqlXADataSource"/>
        <property name="poolSize" value="10"/>
        <property name="minPoolSize" value="10"/>
        <property name="maxPoolSize" value="30"/>
        <property name="borrowConnectionTimeout" value="60"/>  <!--获取连接失败重新获等待最大时间，在这个时间内如果有可用连接，将返回-->
        <property name="reapTimeout"
                  value="20"/> <!--最大获取数据时间，如果不设置这个值，Atomikos使用默认的5分钟，那么在处理大批量数据读取的时候，一旦超过5分钟，就会抛出类似 Resultset is close 的错误.-->
        <property name="maxIdleTime" value="60"/>    <!--最大闲置时间，超过最小连接池连接的连接将将关闭-->
        <property name="maintenanceInterval" value="60"/>  <!--连接回收时间-->
        <property name="loginTimeout" value="60"/>     <!--java数据库连接池，最大可等待获取datasouce的时间-->
        <property name="logWriter" value="60"/>
        <property name="testQuery">
            <value>select 1</value>
        </property>
    </bean>
    <bean id="userDataSource" parent="abstractXADataSource">
        <property name="uniqueResourceName" value="orderDataSource"/>
        <property name="xaDataSourceClassName" value="com.mysql.cj.jdbc.MysqlXADataSource"/>
        <property name="xaProperties">
            <props>
                <prop key="user">root</prop>
                <prop key="password">root</prop>
                <prop key="URL">jdbc:mysql://192.168.238.150:3306/user?serverTimezone=GMT&amp;useSSL=true&amp;useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;failOverReadOnly=false</prop>
            </props>
        </property>
        <property name="poolSize" value="20"/>
    </bean>
    <!--atomiko transaction manager-->
    <bean id="atomiokosTransactionManager" class="com.atomikos.icatch.jta.UserTransactionManager" init-method="init"
          destroy-method="close">
        <property name="forceShutdown" value="true"/>
    </bean>
    <bean id="atomikosUserTransaction" class="com.atomikos.icatch.jta.UserTransactionImp">
        <property name="transactionTimeout" value="300"/>
    </bean>
    <bean id="springTransactionManager" class="org.springframework.transaction.jta.JtaTransactionManager">
        <property name="transactionManager" ref="atomiokosTransactionManager"/>
        <property name="userTransaction" ref="atomikosUserTransaction"/>
    </bean>
    <bean id="transactionTemplate" class="org.springframework.transaction.support.TransactionTemplate">
        <property name="transactionManager" ref="springTransactionManager"/>
    </bean>
    <bean id="userJdbcTemplate" class="org.springframework.jdbc.core.JdbcTemplate">
        <constructor-arg ref="userDataSource"/>
    </bean>
    <context:component-scan base-package="com.tom"/>
    <context:annotation-config/>
    <tx:annotation-driven transaction-manager="springTransactionManager"/>
</beans>
```



### 订单中心



#### `order-api`

引模块用于定义向外暴露的接口

##### `pom.xml`

```xml
<?xml version="1.0" encoding="UTF-8"?>

<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>gs-xtransaction-demo</artifactId>
        <groupId>com.tom</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>
    <artifactId>order-api</artifactId>
    <name>order-api</name>
    <dependencies>
        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
        </dependency>
        <dependency>
            <groupId>org.slf4j</groupId>
            <artifactId>slf4j-simple</artifactId>
        </dependency>
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>fastjson</artifactId>
        </dependency>
    </dependencies>
</project>
```

##### 请求参数`DoOrderRequest.java`

```java
@Data
@NoArgsConstructor
@AllArgsConstructor
public class DoOrderRequest implements Serializable {
    private static final long serialVersionUID = 6777309018108990724L;
    private String name;
}
```

##### 响应参数`DoOrderResponse.java`

```java
@Data
@NoArgsConstructor
public class DoOrderResponse implements Serializable {
    private static final long serialVersionUID = 4038461615509714712L;
    public DoOrderResponse(String code, String desc) {
        this.code = code;
        this.desc = desc;
    }
    private String code;
    private String desc;
    private Object data;
}
```

##### `OrderService.java`

```java
public interface OrderService {
    DoOrderResponse doOrder(DoOrderRequest doOrderRequest);
}
```

##### `META-INF/client/order-customer.xml`

用于向注册中心获取服务

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:dubbo="http://code.alibabatech.com/schema/dubbo"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/context
        http://www.springframework.org/schema/context/spring-context-3.0.xsd
        http://code.alibabatech.com/schema/dubbo
        http://code.alibabatech.com/schema/dubbo/dubbo.xsd" default-autowire="byName">
    <context:annotation-config/>
    <dubbo:reference id="orderServices"
                     interface="com.tom.service.OrderService"
                     protocol="dubbo">
    </dubbo:reference>
</beans>
```

#### order-provider

##### `pom.xml`

```xml
<?xml version="1.0" encoding="UTF-8"?>

<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>gs-xtransaction-demo</artifactId>
        <groupId>com.tom</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>
    <artifactId>order-provider</artifactId>
    <name>order-provider</name>
    <dependencies>
        <dependency>
            <groupId>com.tom</groupId>
            <artifactId>order-api</artifactId>
        </dependency>
        <dependency>
            <groupId>com.tom</groupId>
            <artifactId>user-api</artifactId>
        </dependency>
        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
        </dependency>
        <!-- spring-->
        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-core</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-beans</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-context</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-context-support</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-jdbc</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-orm</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-tx</artifactId>
        </dependency>
        <!--dubbo-->
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>dubbo</artifactId>
        </dependency>
        <dependency>
            <groupId>com.github.sgroschupf</groupId>
            <artifactId>zkclient</artifactId>
        </dependency>
        <dependency>
            <groupId>com.atomikos</groupId>
            <artifactId>transactions-jdbc</artifactId>
        </dependency>
        <dependency>
            <groupId>javax.transaction</groupId>
            <artifactId>jta</artifactId>
        </dependency>
        <dependency>
            <groupId>javax</groupId>
            <artifactId>javaee-api</artifactId>
        </dependency>
        <!--mybatis-->
        <dependency>
            <groupId>org.mybatis</groupId>
            <artifactId>mybatis</artifactId>
        </dependency>
        <dependency>
            <groupId>org.mybatis</groupId>
            <artifactId>mybatis-spring</artifactId>
        </dependency>
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
        </dependency>
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>fastjson</artifactId>
        </dependency>
        <dependency>
            <groupId>org.slf4j</groupId>
            <artifactId>slf4j-simple</artifactId>
        </dependency>
    </dependencies>
</project>
```

##### `OrderDao.java`

```java
public interface OrderDao {
    void save();
}
```

##### `OrderDaoImpl.java`

```java
@Repository
public class OrderDaoImpl implements OrderDao {
    @Autowired
    JdbcTemplate orderJdbcTemplate;
    @Override
    public void save() {
        orderJdbcTemplate.execute("INSERT INTO `order` (`status`,price,order_time) VALUES(1,10,now())");
    }
}
```

##### `OrderServiceImpl.java`

会依赖用户中心的服务，从订单模块调到用户中心去。

```java
@Service("orderService")
@Slf4j
public class OrderServiceImpl implements OrderService {
    @Autowired
    OrderDao orderDao;
    @Autowired
    UserService userService;
    @Autowired
    JtaTransactionManager springTransactionManager;

    @Override
    public DoOrderResponse doOrder(DoOrderRequest doOrderRequest) {
        log.info("调到订单模块中心 ：{}", JSON.toJSONString(doOrderRequest));
        UserTransaction userTransaction = springTransactionManager.getUserTransaction();
        try {
            userTransaction.begin();
            orderDao.save();
            RechargeRes rechargeRes = userService.recharge(new RechargeReq());
            userTransaction.commit();
        } catch (NotSupportedException | SystemException e) {
            log.error("{}", e);
        } catch (Exception e) {
            log.error("{}", e);
            try {
                userTransaction.rollback();
            } catch (SystemException ex) {
                log.error("{}", ex);
            }
        }
        DoOrderResponse response = new DoOrderResponse("0000", "下单成功");

        return response;
    }
}
```

##### `application.properties`

```properties
application.name=dubbo-order
dubbo.service.provider.port=20880
dubbo.service.provider.threads=200
dubbo.cache.dir=/tmp/cache
dubbo.zk.servers=192.168.238.150:2181,192.168.238.155:2181,192.168.238.160:2181,192.168.238.165:2181
dubbo.zk.group=dubbo-dev
dubbo.application.owner=tom,jack
dubbo.protocol.accesslog=/tmp/dubbo-order.log
```

##### `transactions.properties`

```properties
com.atomikos.icatch.log_base_dir=/tmp/order/
com.atomikos.icatch.output_dir=/tmp/order/
```

##### `META-INF/spring/service-order.xml`

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:dubbo="http://code.alibabatech.com/schema/dubbo"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://code.alibabatech.com/schema/dubbo
        http://code.alibabatech.com/schema/dubbo/dubbo.xsd" default-autowire="byName">
    <!--服务发布的配置，需要暴露的服务接口-->
    <dubbo:service interface="com.tom.service.OrderService" ref="orderService"
                   protocol="dubbo" timeout="3000"/>
</beans>
```

##### `META-INF/spring/service-provider.xml`

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:dubbo="http://code.alibabatech.com/schema/dubbo"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://code.alibabatech.com/schema/dubbo
        http://code.alibabatech.com/schema/dubbo/dubbo.xsd" default-autowire="byName">
    <!--当前项目在整个分布式架构里面的唯一名称，计算依赖关系的标签-->
    <dubbo:application name="${application.name}" owner="${dubbo.application.owner}"/>
    <!--dubbo这个服务所要暴露的服务地址所对应的注册中心-->
    <dubbo:registry protocol="zookeeper"
                    address="${dubbo.zk.servers}"
                    group="${dubbo.zk.group}"
                    file="${dubbo.cache.dir}/dubbo-order.cache"/>
    <!--当前服务发布所依赖的协议；webserovice、Thrift、Hessain、http-->
    <dubbo:protocol
            name="dubbo"
            port="${dubbo.service.provider.port}"
            threadpool="cached"
            threads="${dubbo.service.provider.threads:200}"
            accesslog="${dubbo.protocol.accesslog}"/>
    <import resource="classpath*:META-INF/client/user-customer.xml"/>
</beans>
```

##### `META-INF/spring/service-common.xml`

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:tx="http://www.springframework.org/schema/tx"
       xmlns:context="http://www.springframework.org/schema/context"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/tx
        http://www.springframework.org/schema/tx/spring-tx-4.3.xsd
        http://www.springframework.org/schema/context
        http://www.springframework.org/schema/context/spring-context-4.3.xsd" default-autowire="byName">
    <context:property-placeholder location="classpath:application.properties"/>
    <bean id="abstractXADataSource" class="com.atomikos.jdbc.AtomikosDataSourceBean" init-method="init"
          destroy-method="close" abstract="true">
        <property name="xaDataSourceClassName" value="com.mysql.cj.jdbc.MysqlXADataSource"/>
        <property name="poolSize" value="10"/>
        <property name="minPoolSize" value="10"/>
        <property name="maxPoolSize" value="30"/>
        <property name="borrowConnectionTimeout" value="60"/>  <!--获取连接失败重新获等待最大时间，在这个时间内如果有可用连接，将返回-->
        <property name="reapTimeout"
                  value="20"/> <!--最大获取数据时间，如果不设置这个值，Atomikos使用默认的5分钟，那么在处理大批量数据读取的时候，一旦超过5分钟，就会抛出类似 Resultset is close 的错误.-->
        <property name="maxIdleTime" value="60"/>    <!--最大闲置时间，超过最小连接池连接的连接将将关闭-->
        <property name="maintenanceInterval" value="60"/>  <!--连接回收时间-->
        <property name="loginTimeout" value="60"/>     <!--java数据库连接池，最大可等待获取datasouce的时间-->
        <property name="logWriter" value="60"/>
        <property name="testQuery">
            <value>select 1</value>
        </property>
    </bean>
    <bean id="orderDataSource" parent="abstractXADataSource">
        <property name="uniqueResourceName" value="orderDataSource"/>
        <property name="xaDataSourceClassName" value="com.mysql.cj.jdbc.MysqlXADataSource"/>
        <property name="xaProperties">
            <props>
                <prop key="user">root</prop>
                <prop key="password">root</prop>
                <prop key="URL">jdbc:mysql://192.168.238.150:3306/order?serverTimezone=GMT&amp;useSSL=true&amp;useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;failOverReadOnly=false</prop>
            </props>
        </property>
        <property name="poolSize" value="20"/>
    </bean>
    <!--atomiko transaction manager-->
    <bean id="atomiokosTransactionManager" class="com.atomikos.icatch.jta.UserTransactionManager" init-method="init"
          destroy-method="close">
        <property name="forceShutdown" value="true"/>
    </bean>
    <bean id="atomikosOrderTransaction" class="com.atomikos.icatch.jta.UserTransactionImp">
        <property name="transactionTimeout" value="300"/>
    </bean>
    <bean id="springTransactionManager" class="org.springframework.transaction.jta.JtaTransactionManager">
        <property name="transactionManager" ref="atomiokosTransactionManager"/>
        <property name="userTransaction" ref="atomikosOrderTransaction"/>
    </bean>
    <bean id="transactionTemplate" class="org.springframework.transaction.support.TransactionTemplate">
        <property name="transactionManager" ref="springTransactionManager"/>
    </bean>
    <bean id="orderJdbcTemplate" class="org.springframework.jdbc.core.JdbcTemplate">
        <constructor-arg ref="orderDataSource"/>
    </bean>
    <context:component-scan base-package="com.tom"/>
    <context:annotation-config/>
    <tx:annotation-driven transaction-manager="springTransactionManager"/>
</beans>
```

##### 应用启动类`Bootstrap.java`

```java
public class Bootstrap {
    public static void main(String[] args) {
        System.setProperty("java.net.preferIPv4Stack", "true");
        Main.main(args);
    }
}
```

### 门户站

#### `pom.xml`

增加用户中心和订单中心的依赖，以及dubbo的依赖

```xml
<dependency>
    <groupId>com.tom</groupId>
    <artifactId>order-api</artifactId>
</dependency>
<dependency>
    <groupId>com.tom</groupId>
    <artifactId>user-api</artifactId>
</dependency>
<!--dubbo-->
<dependency>
    <groupId>com.alibaba</groupId>
    <artifactId>dubbo</artifactId>
</dependency>
<dependency>
    <groupId>com.github.sgroschupf</groupId>
    <artifactId>zkclient</artifactId>
</dependency>
```

#### `src/main/resources/spring/dubbo.xml`

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:dubbo="http://code.alibabatech.com/schema/dubbo"
       xmlns:context="http://www.springframework.org/schema/context"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/context
        http://www.springframework.org/schema/context/spring-context-3.0.xsd
        http://code.alibabatech.com/schema/dubbo
        http://code.alibabatech.com/schema/dubbo/dubbo.xsd"
       default-autowire="byName">
    <dubbo:application name="gs-dubbo-webiste"  />
    <dubbo:registry protocol="zookeeper" file="/tmp/gs.website.cache" group="dubbo-dev"                  address="192.168.238.150:2181,192.168.238.155:2181,192.168.238.160:2181,192.168.238.165:2181"/>
    <import resource="classpath*:META-INF/client/order-customer.xml"/>
    <import resource="classpath*:META-INF/client/user-customer.xml"/>
</beans>
```

#### 启动类`App.java`

```java
@SpringBootApplication
@ImportResource({"classpath*:spring/dubbo.xml"})
public class App {
    public static void main(String[] args) {
        SpringApplication.run(GsSiteApplication.class, args);
    }
}
```

#### 调用类`HelloController.java`

```java
@RestController
@Slf4j
public class HelloController {
    @Autowired
    @Qualifier(value = "orderServices")
    private OrderService orderService;
    @GetMapping
    public String sayHello() {
        DoOrderRequest doOrderRequest = new DoOrderRequest("tom");
        log.info("请求到门户：{}",JSON.toJSONString(doOrderRequest));
        orderService.doOrder(doOrderRequest);
        return "hello";
    }
}
```

## 总结

### 分布式事务产生的原因

a)   数据库分库分表

b)  服务soa化

c)   *在分布式系统中，每一个机器节点虽然都能明确的知道自己执行的事务是成功还是失败，但是却无法知道其他分布式节点的事务执行情况。因此，当一个事务要跨越多个分布式节点的时候（比如，下单流程，下单系统和库存系统可能就是分别部署在不同的分布式节点中），为了保证该事务可以满足ACID，就要引入一个协调者（Cooradinator）。其他的节点被称为参与者（Participant）。协调者负责调度参与者的行为，并最终决定这些参与者是否要把事务进行提交。*

### X/OPEN DTP

AP  application， 应用程序

RM  resource manager ，资源管理，一般表示数据库，必须实现XA定义的接口

TM   transaction manager 事务管理器，负责协调和事务管理 

### 2pc提交协议

a)   提交事务请求（投票）

b)  执行事务请求（提交或中断）

### 2pc的数据一致性问题

a)   数据不一致。在二阶段提交的阶段二中，当协调者向参与者发送commit请求之后，发生了局部网络异常或者在发送commit请求过程中协调者发生了故障，这回导致只有一部分参与者接受到了commit请求。而在这部分参与者接到commit请求之后就会执行commit操作。但是其他部分未接到commit请求的机器则无法执行事务提交。于是整个分布式系统便出现了数据部一致性的现象。

b)  同步阻塞问题。执行过程中，所有参与节点都是事务阻塞型的。当参与者占有公共资源时，其他第三方节点访问公共资源不得不处于阻塞状态

c)   二阶段无法解决的问题：协调者在发出commit消息之后宕机，而唯一接收到这条消息的参与者同时也宕机了。那么即使协调者通过选举协议产生了新的协调者，这条事务的状态也是不确定的，没人知道事务是否被已经提交

d)  单点故障。由于协调者的重要性，一旦协调者发生故障。参与者会一直阻塞下去

### 3pc提交协议

a)   canCommit

b)  preCommit

c)   doCommit

改进点

a)   增加了超时机制

b)  第二阶段，如果协调者超时没有接受到参与者的反馈，则自动认为失败，发送abort命令

c)   第三阶段，如果参与者超时没有接受到协调者的反馈，则自动认为成功开始提交事务（基于概率）

### 3pc的问题

相对于2PC，3PC主要解决的单点故障问题，并减少阻塞，因为一旦参与者无法及时收到来自协调者的信息之后，他会默认执行commit。而不会一直持有事务资源并处于阻塞状态。但是这种机制也会导致数据一致性问题，因为，由于网络原因，协调者发送的abort响应没有及时被参与者接收到，那么参与者在等待超时之后执行了commit操作。这样就和其他接到abort命令并执行回滚的参与者之间存在数据不一致的情况。

### XA/JTA

XA 就是 X/Open DTP 定义的事务管理器与资源管理器的接口规范（即接口函数），XA 接口函数由数据库厂商提供。

JTA是基于X/Open DTP模型开发的java transaction APi规范



## Issuers

### 1. MySQL server version for the right syntax 

```mysql
mysql> CREATE DATABASE order CHARACTER SET utf8 COLLATE utf8_general_ci;
ERROR 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'order CHARACTER SET utf8 COLLATE utf8_general_ci' at line 1
```


Alternatively, you can use 'CREATE SCHEMA' instead of 'CREATE DATABASE':

```mysql
CREATE SCHEMA `order` CHARACTER SET utf8 COLLATE utf8_general_ci;
GRANT ALL ON `order`.* TO `root`@localhost IDENTIFIED BY 'root';
```

## 2. Log already in use?

atomikos的默认配置`transactions-4.0.6.jar!/transactions-defaults.properties`

```properties
com.atomikos.icatch.enable_logging=true
com.atomikos.icatch.force_shutdown_on_vm_exit=false
com.atomikos.icatch.automatic_resource_registration=true
com.atomikos.icatch.checkpoint_interval=500
com.atomikos.icatch.serial_jta_transactions=true
com.atomikos.icatch.default_jta_timeout=10000
com.atomikos.icatch.max_timeout=300000
com.atomikos.icatch.log_base_dir=./
com.atomikos.icatch.threaded_2pc=false
com.atomikos.icatch.max_actives=50
com.atomikos.icatch.log_base_name=tmlog
java.naming.factory.initial=com.sun.jndi.rmi.registry.RegistryContextFactory
com.atomikos.icatch.client_demarcation=false
java.naming.provider.url=rmi://localhost:1099
com.atomikos.icatch.rmi_export_class=none
com.atomikos.icatch.trust_client_tm=false
com.atomikos.icatch.forget_orphaned_log_entries_delay=86400000
com.atomikos.icatch.recovery_delay=${com.atomikos.icatch.default_jta_timeout}
com.atomikos.icatch.oltp_max_retries=5
com.atomikos.icatch.oltp_retry_interval=10000
com.atomikos.icatch.allow_subtransactions=true
com.atomikos.icatch.default_max_wait_time_on_shutdown=9223372036854775807
```

从上面可以看到 com.atomikos.icatch.log_base_dir 和 com.atomikos.icatch.output_dir 都是当前目录的

```
com.atomikos.icatch.log_base_dir=.\
com.atomikos.icatch.output_dir=.\
```

所以多个项目同时在Tomcat启动的时候，就会报以上的问题. 而且我们可以在Tomcat的bin目录下看到如下的文件:

```
{your IP}.tm0.epoch
tmlog.lck
tmlog0.log
```

新增文件`transactions.properties`

```properties
com.atomikos.icatch.log_base_dir=/tmp/order/
com.atomikos.icatch.output_dir=/tmp/order/
```

